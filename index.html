import asyncio
import json
import logging
import base64
from datetime import datetime
from typing import List, Optional

from aiogram import Bot, Dispatcher, types, Router
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup, WebAppInfo
from aiogram.filters import Command
from fastapi import FastAPI, HTTPException, File, UploadFile
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field

# Configure logging
logging.basicConfig(level=logging.INFO)

# Initialize FastAPI app
app = FastAPI()

# Configure CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Initialize bot and dispatcher
BOT_TOKEN = "7464354930:AAEaBKgmPM7ZnmGvVP0feLNiYNA4y76GKMQ"  # Bot token
WEBAPP_URL = "https://competidora-cmd.github.io/outfit-generator/"

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

# Create router
router = Router()

# Data models
class ClothingItem(BaseModel):
    id: Optional[int] = None
    image_url: str = Field(..., description="Base64 encoded image data")
    user_id: int
    price: Optional[str] = None
    type: Optional[str] = None
    layer_type: Optional[str] = None
    category: Optional[str] = None
    brand: Optional[str] = None
    size: Optional[str] = None
    style: Optional[str] = None
    material: Optional[str] = None
    color: Optional[str] = None
    condition: Optional[str] = None
    created_at: Optional[datetime] = Field(default_factory=datetime.now)
    updated_at: Optional[datetime] = Field(default_factory=datetime.now)

class Outfit(BaseModel):
    id: Optional[int]
    user_id: int
    items: List[int]
    name: Optional[str]
    description: Optional[str]
    created_at: Optional[datetime] = datetime.now()
    updated_at: Optional[datetime] = datetime.now()

# In-memory storage
clothing_items = []
outfits = []
item_counter = 1
outfit_counter = 1

# FastAPI routes
@app.get("/")
async def root():
    return {"message": "FITTED API"}

@app.post("/items/")
async def create_item(item: ClothingItem):
    global item_counter
    try:
        # Validate base64 image
        if not item.image_url.startswith('data:image'):
            raise HTTPException(status_code=400, detail="Invalid image format")
        
        item.id = item_counter
        item_counter += 1
        clothing_items.append(item)
        return item
    except Exception as e:
        raise HTTPException(status_code=400, detail=str(e))

@app.get("/items/{user_id}")
async def get_user_items(user_id: int):
    user_items = [item for item in clothing_items if item.user_id == user_id]
    return user_items

@app.post("/outfits/")
async def create_outfit(outfit: Outfit):
    global outfit_counter
    outfit.id = outfit_counter
    outfit_counter += 1
    outfits.append(outfit)
    return outfit

@app.get("/outfits/{user_id}")
async def get_user_outfits(user_id: int):
    user_outfits = [outfit for outfit in outfits if outfit.user_id == user_id]
    return user_outfits

@app.delete("/items/{item_id}")
async def delete_item(item_id: int):
    for i, item in enumerate(clothing_items):
        if item.id == item_id:
            del clothing_items[i]
            return {"message": "Item deleted"}
    raise HTTPException(status_code=404, detail="Item not found")

@app.delete("/outfits/{outfit_id}")
async def delete_outfit(outfit_id: int):
    for i, outfit in enumerate(outfits):
        if outfit.id == outfit_id:
            del outfits[i]
            return {"message": "Outfit deleted"}
    raise HTTPException(status_code=404, detail="Outfit not found")

# Telegram bot handlers
@router.message(Command("start"))
async def start_cmd(message: types.Message):
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(
                text="Open Wardrobe",
                web_app=WebAppInfo(url=WEBAPP_URL)
            )]
        ]
    )
    
    await message.answer(
        "Welcome to FITTED! ðŸ‘•\n"
        "Your personal wardrobe management assistant.\n\n"
        "Click the button below to start managing your wardrobe:",
        reply_markup=keyboard
    )

@router.message(Command("help"))
async def help_cmd(message: types.Message):
    help_text = (
        "Available commands:\n"
        "/start - Start the bot and open the wardrobe\n"
        "/help - Show this help message\n"
        "/wardrobe - Open your wardrobe\n"
        "/outfits - View and manage your outfits"
    )
    await message.answer(help_text)

@router.message(Command("wardrobe"))
async def wardrobe_cmd(message: types.Message):
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(
                text="Open Wardrobe",
                web_app=WebAppInfo(url=f"{WEBAPP_URL}?section=pieces")
            )]
        ]
    )
    await message.answer("Click to manage your wardrobe:", reply_markup=keyboard)

@router.message(Command("outfits"))
async def outfits_cmd(message: types.Message):
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [InlineKeyboardButton(
                text="View Outfits",
                web_app=WebAppInfo(url=f"{WEBAPP_URL}?section=fits")
            )]
        ]
    )
    await message.answer("Click to view your outfits:", reply_markup=keyboard)

@router.message()
async def handle_webapp_data(message: types.Message):
    if message.web_app_data:
        try:
            data = json.loads(message.web_app_data.data)
            if data.get('type') == 'item_added':
                await message.answer(f"New item added to your wardrobe!")
            elif data.get('type') == 'create_outfit':
                await message.answer(f"New outfit created!")
        except json.JSONDecodeError:
            await message.answer("Error processing data from web app")

# Run both FastAPI and Telegram bot
async def run_bot():
    try:
        # Include router
        dp.include_router(router)
        
        # Start polling
        await dp.start_polling(bot)
    finally:
        await bot.session.close()

if __name__ == "__main__":
    import uvicorn
    from contextlib import asynccontextmanager
    
    @asynccontextmanager
    async def lifespan(app: FastAPI):
        # Start the bot
        asyncio.create_task(run_bot())
        yield
        # Shutdown bot on app shutdown
        await bot.session.close()
    
    app.router.lifespan_context = lifespan
    
    # Run FastAPI
    uvicorn.run(app, host="0.0.0.0", port=8000) 
