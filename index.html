    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
        <title>FITTED</title>
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                -webkit-tap-highlight-color: transparent;
            }

            html, body {
                position: fixed;
                width: 100%;
                height: 100%;
                overflow: hidden;
                overscroll-behavior: none;
            }

            body {
                background-color: #fff;
                color: #000;
            }

            .container {
                height: 100%;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                padding-bottom: 80px;
            }

            /* Header Styles */
            header {
                padding: 20px;
                background-color: #fff;
                position: sticky;
                top: 0;
                z-index: 100;
            }

            .logo {
                text-align: center;
                margin-bottom: 20px;
            }

            .logo img {
                height: 40px;
            }

            .main-nav {
                display: flex;
                justify-content: center;
                gap: 20px;
                margin-bottom: 15px;
                border-radius: 15px;
                background-color: #f5f5f5;
                padding: 5px;
            }

            .main-nav .nav-item {
                padding: 10px 20px;
                cursor: pointer;
                border-radius: 12px;
                color: #666;
            }

            .main-nav .nav-item.active {
                background-color: #fff;
                color: #000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .sub-nav {
                display: flex;
                gap: 15px;
                overflow-x: auto;
                padding: 10px 0;
                -webkit-overflow-scrolling: touch;
            }

            .sub-nav .nav-item {
                padding: 8px 16px;
                border-radius: 20px;
                background-color: #f5f5f5;
                white-space: nowrap;
                cursor: pointer;
            }

            .sub-nav .nav-item.active {
                background-color: #000;
                color: #fff;
            }

            /* Main Content */
            main {
                flex: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
            }

            .grid-container {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 20px;
                padding: 20px;
                padding-bottom: 100px;
            }

            .add-piece-card {
                border: 2px dashed #ccc;
                border-radius: 15px;
                padding: 20px;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                cursor: pointer;
                min-height: 200px;
            }

            .add-icon {
                font-size: 32px;
                color: #666;
            }

            .add-text {
                font-weight: 600;
            }

            .piece-count {
                font-size: 14px;
                color: #666;
            }

            .upgrade-btn {
                background-color: #40b6ff;
                color: #fff;
                border: none;
                padding: 8px 16px;
                border-radius: 20px;
                font-weight: 600;
                cursor: pointer;
            }

            .clothing-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 20px;
            }

            .clothing-item {
                background-color: #f5f5f5;
                border-radius: 15px;
                overflow: hidden;
                aspect-ratio: 1;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .clothing-item img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                background: #f5f5f5;
                display: block;
            }

            .clothing-item::before,
            .clothing-item::after,
            .clothing-item *::before,
            .clothing-item *::after {
                display: none !important;
                content: none !important;
            }

            /* Item Actions */
            .item-actions {
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 5px;
                opacity: 0;
                transition: opacity 0.3s;
            }

            .clothing-item:hover .item-actions {
                opacity: 1;
            }

            .action-btn {
                background: rgba(255, 255, 255, 0.9);
                border: none;
                border-radius: 50%;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            /* Outfit Grid */
            .outfit-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
                padding: 20px;
            }

            .outfit-card {
                background: #fff;
                border-radius: 15px;
                padding: 20px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                display: grid;
                grid-template-rows: auto 1fr auto;
                gap: 15px;
            }

            .outfit-items {
                display: grid;
                grid-template-rows: repeat(3, 1fr);
                gap: 10px;
                aspect-ratio: 0.7;
            }

            .outfit-item {
                background: #f5f5f5;
                border-radius: 10px;
                overflow: hidden;
                position: relative;
            }

            .outfit-item img {
                width: 100%;
                height: 100%;
                object-fit: contain;
            }

            /* Image Editor */
            .image-editor {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                z-index: 2000;
            }

            .editor-content {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #fff;
                padding: 20px;
                border-radius: 15px;
                width: 90%;
                max-width: 800px;
                height: 80vh;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            .editor-canvas-container {
                position: relative;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #editorCanvas {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                max-width: 100%;
                max-height: 100%;
            }

            .editor-tools {
                display: flex;
                gap: 10px;
                justify-content: center;
            }

            .editor-btn {
                padding: 10px 20px;
                border: none;
                border-radius: 20px;
                background: #000;
                color: #fff;
                cursor: pointer;
            }

            .editor-btn.secondary {
                background: #f5f5f5;
                color: #000;
            }

            /* Create Outfit Button */
            .create-outfit-btn {
                position: fixed;
                bottom: 100px;
                left: 50%;
                transform: translateX(-50%);
                background: #000;
                color: #fff;
                border: none;
                padding: 15px 30px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                z-index: 999;
                transition: all 0.3s ease;
                margin-bottom: env(safe-area-inset-bottom, 0px);
            }

            @media (max-width: 768px) {
                .create-outfit-btn {
                    bottom: 80px;
                    padding: 12px 24px;
                    font-size: 14px;
                }
            }

            .create-outfit-btn:hover {
                transform: translateX(-50%) scale(1.05);
                box-shadow: 0 6px 16px rgba(64, 182, 255, 0.4);
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 3000;
            }

            .modal-content {
                background-color: #fff;
                border-radius: 20px 20px 0 0;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 90vh;
                height: 90vh;
                overflow-y: auto;
                padding: 20px;
                padding-bottom: 100px;
                -webkit-overflow-scrolling: touch;
                z-index: 3001;
            }

            /* Form Actions - Fixed at bottom */
            .form-actions {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #fff;
                padding: 15px;
                border-top: 1px solid #eee;
                display: flex;
                justify-content: center;
                z-index: 3002;
                padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
            }

            .upload-action-btn {
                background: #000;
                color: #fff;
                border: none;
                padding: 15px 30px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                min-width: 200px;
                -webkit-appearance: none;
                width: 100%;
                max-width: 300px;
            }

            @media (max-width: 768px) {
                .form-actions {
                    padding: 10px;
                }
                
                .upload-action-btn {
                    padding: 12px 24px;
                    font-size: 14px;
                    min-width: 150px;
                }
            }

            /* Image Preview Styles */
            .image-preview {
                width: 100%;
                height: 300px;
                border-radius: 15px;
                overflow: hidden;
                margin-bottom: 20px;
                display: none;
                position: relative;
                background-color: #f5f5f5;
            }

            .image-preview img {
                width: 100%;
                height: 100%;
                object-fit: contain;
                display: block;
                background: #f5f5f5;
            }

            .preview-actions {
                position: absolute;
                top: 10px;
                right: 10px;
                display: flex;
                gap: 10px;
                z-index: 10;
            }

            .preview-action-btn {
                background: rgba(255, 255, 255, 0.9);
                border: none;
                border-radius: 20px;
                padding: 8px 16px;
                font-size: 14px;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 5px;
            }

            #autoRemoveBtn {
                background: #40b6ff;
                color: white;
            }

            .preview-action-btn:hover {
                transform: scale(1.05);
            }

            @media (max-width: 768px) {
                .preview-actions {
                    flex-direction: column;
                    top: 10px;
                    right: 10px;
                }
                
                .preview-action-btn {
                    padding: 6px 12px;
                    font-size: 12px;
                }
            }

            /* Form Styles */
            .form-list {
                display: flex;
                flex-direction: column;
                gap: 15px;
                padding: 0 10px;
                -webkit-overflow-scrolling: touch;
            }

            .form-item {
                margin-bottom: 15px;
            }

            .form-item input,
            .form-item select,
            .input-container input {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 8px;
                font-size: 16px;
                color: #000 !important;
                background: #fff;
                -webkit-appearance: none;
                appearance: none;
            }

            .input-container {
                position: relative;
                width: 100%;
                color: #000;
            }

            .form-item label {
                display: block;
                margin-bottom: 8px;
                color: #000;
                font-weight: 500;
            }

            .upload-prompt {
                color: #000;
                font-weight: 500;
            }

            .modal-header h2,
            .first-name,
            .second-name,
            .stat-value,
            .stat-label {
                color: #000;
            }

            /* Profile Styles */
            .profile {
                animation: loadProfile 0.6s ease-in-out;
                animation-fill-mode: both;
                font-size: 0.9rem;
                display: flex;
                flex-direction: column;
                position: relative;
                padding: 20px;
                height: 100%;
                background: #fff;
            }

            .profile-image {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                overflow: hidden;
                margin: 0 auto;
                background-size: cover;
                background-position: center;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .profile-info {
                text-align: center;
                margin-top: 20px;
            }

            .profile-info h1 {
                font-size: 24px;
                font-weight: 600;
                margin: 5px 0;
                color: #000;
            }

            h1.first-name {
                margin-bottom: 0;
            }

            h1.second-name {
                color: #666;
                font-size: 16px;
                margin-top: 0;
            }

            .profile-stats {
                display: flex;
                justify-content: center;
                gap: 40px;
                margin-top: 20px;
                padding: 15px;
                background: #f8f8f8;
                border-radius: 15px;
            }

            .stat-item {
                text-align: center;
            }

            .stat-value {
                font-size: 24px;
                font-weight: 600;
                color: #000;
            }

            .stat-label {
                font-size: 14px;
                color: #666;
                margin-top: 5px;
            }

            @media only screen and (max-aspect-ratio: 4/7) and (max-width: 600px) {
                .profile {
                    margin: 3%;
                    height: 97%;
                }
                .container {
                    height: 86%;
                    flex-direction: column;
                }
                .profile-image {
                    height: 40%;
                    width: calc(100% - 90px);
                }
                .profile-bg {
                    width: 100%;
                }
                h1.first-name {
                    left: 10px;
                }
                h1.second-name {
                    left: 60px;
                }
                .profile-stats {
                    margin-top: 120px;
                }
            }

            @keyframes loadProfile {
                from {
                    transform: translateY(100px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0px);
                    opacity: 1;
                }
            }

            @keyframes loadProfileImage {
                from {
                    transform: translateY(50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0px);
                    opacity: 1;
                }
            }

            @keyframes titleEffect {
                from {
                    opacity: 0;
                    transform: translateX(-75px);
                }
                to {
                    transform: translateX(0px);
                    opacity: 1;
                }
            }

            /* Bottom Navigation */
            .bottom-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #fff;
                display: flex;
                justify-content: space-around;
                padding: 15px;
                border-top: 1px solid #eee;
                z-index: 1000;
                padding-bottom: calc(15px + env(safe-area-inset-bottom, 0px));
            }

            .bottom-nav .nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 5px;
                cursor: pointer;
                padding: 5px 15px;
                z-index: 1001;
            }

            .bottom-nav .nav-item img {
                width: 24px;
                height: 24px;
            }

            .bottom-nav .nav-item span {
                font-size: 12px;
                color: #666;
            }

            .bottom-nav .nav-item.active span {
                color: #000;
            }

            /* Upload Button */
            .upload-button {
                display: none !important;
            }

            .upload-area {
                width: 100%;
                height: 200px;
                border: 2px dashed #ccc;
                border-radius: 15px;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                margin-bottom: 20px;
                background: #f5f5f5;
            }

            .upload-area.dragover {
                border-color: #000;
                background: #f0f0f0;
            }

            .upload-prompt {
                text-align: center;
                color: #666;
            }

            /* New Upload Styles */
            .new-upload-container {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                margin-bottom: 20px;
            }

            .image-container {
                width: 100%;
                height: 300px;
                border-radius: 15px;
                background-color: #f5f5f5;
                position: relative;
                overflow: hidden;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            #previewImage {
                width: 100%;
                height: 100%;
                object-fit: contain;
                display: none;
            }

            .upload-placeholder {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 10px;
                color: #666;
            }

            .upload-icon {
                font-size: 48px;
            }

            .upload-text {
                font-size: 16px;
                font-weight: 500;
            }

            .upload-btn {
                background: #40b6ff;
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
                transition: transform 0.2s;
            }

            .upload-btn:hover {
                transform: scale(1.05);
            }

            .preview-actions {
                display: none;
                justify-content: center;
                gap: 10px;
                margin-bottom: 20px;
            }

            @media (max-width: 768px) {
                .image-container {
                    height: 250px;
                }
                
                .upload-btn {
                    width: 100%;
                    max-width: 300px;
                }
            }

            /* New Upload Styles */
            .upload-container {
                width: 100%;
                max-width: 500px;
                margin: 0 auto 20px;
                border-radius: 10px;
                box-shadow: 4px 4px 30px rgba(0,0,0,0.1);
                background-color: rgba(0, 110, 255, 0.041);
                overflow: hidden;
            }

            .upload-header {
                display: block;
                cursor: pointer;
            }

            /* Upload Area Styles - улучшение для мобильных устройств */
            .upload-area {
                height: 300px;
                width: 100%;
                border: 2px dashed #40b6ff;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                border-radius: 10px;
                background-position: center;
                background-size: cover;
                position: relative;
                background-color: white;
            }

            #previewImage {
                width: 100%;
                height: 100%;
                object-fit: contain;
                display: none;
                background: white;
                max-height: 300px;
            }

            /* Улучшаем стили для мобильных устройств */
            @media (max-width: 768px) {
                .upload-area {
                    height: 220px;
                    background-color: white;
                }
                
                #previewImage {
                    max-height: 100%;
                    object-fit: contain;
                }
                
                .modal-content {
                    padding-bottom: 120px;
                    background-color: #fff;
                }
                
                .form-actions {
                    background-color: white;
                    box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
                }
                
                .preview-actions {
                    position: fixed;
                    bottom: 70px;
                    left: 0;
                    right: 0;
                    flex-wrap: nowrap;
                    justify-content: space-around;
                    padding: 10px 20px;
                    background-color: white;
                    border-top: 1px solid #eee;
                    z-index: 1000;
                }
                
                .preview-action-btn {
                    flex: 1;
                    margin: 0 5px;
                    border-radius: 8px;
                    height: 40px;
                    padding: 0 5px;
                    font-size: 14px;
                    background-color: white;
                    border: 1px solid #eee;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                }
                
                #autoRemoveBtn {
                    background-color: #40b6ff;
                    color: white;
                    border: none;
                }
            }

            /* Исправляем проблему с серым фоном при открытии модального окна */
            .modal {
                background-color: rgba(0,0,0,0.7);
            }

            .modal-content {
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
            }

            .upload-placeholder {
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                gap: 10px;
                color: #666;
            }

            .upload-icon {
                font-size: 64px;
                color: #40b6ff;
            }

            .upload-text {
                text-align: center;
                color: #666;
                font-weight: 500;
                font-size: 18px;
            }

            .upload-footer {
                background-color: rgba(0, 110, 255, 0.075);
                width: 100%;
                height: 40px;
                padding: 8px;
                border-radius: 0 0 10px 10px;
                display: flex;
                justify-content: center;
                align-items: center;
                color: #666;
                font-size: 14px;
            }

            @media (max-width: 768px) {
                .upload-area {
                    height: 250px;
                }
                
                .upload-icon {
                    font-size: 48px;
                }
                
                .upload-text {
                    font-size: 16px;
                }
            }

            /* Preview actions styles - fix mobile appearance */
            .preview-actions {
                position: absolute;
                top: 10px;
                right: 10px;
                display: none;
                gap: 10px;
                z-index: 10;
            }

            /* Fix buttons appearance */
            .preview-action-btn {
                background: white;
                border: 1px solid #ddd;
                border-radius: 20px;
                padding: 8px 16px;
                font-size: 14px;
                cursor: pointer;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                display: flex;
                align-items: center;
                gap: 5px;
            }

            #autoRemoveBtn {
                background: #40b6ff;
                color: white;
                border: none;
            }

            /* Mobile optimizations */
            @media (max-width: 768px) {
                .preview-actions {
                    position: fixed;
                    bottom: 80px;
                    left: 0;
                    right: 0;
                    top: auto;
                    z-index: 3003;
                    display: none;
                    justify-content: center;
                    gap: 10px;
                    padding: 10px;
                    background-color: white;
                    border-top: 1px solid #eee;
                }
                
                .preview-action-btn {
                    width: 30%;
                    max-width: 120px;
                    height: 40px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    padding: 8px;
                    font-size: 14px;
                    text-align: center;
                    border-radius: 8px;
                }
                
                /* Fix modal background */
                .modal {
                    background-color: rgba(0,0,0,0.7);
                }
                
                /* Fix image preview */
                #previewImage {
                    max-height: 280px;
                    background-color: white;
                }
                
                /* Add shadow to buttons */
                .preview-action-btn {
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <div class="logo">
                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjQwIiB2aWV3Qm94PSIwIDAgMTAwIDQwIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZvbnQtd2VpZ2h0PSJib2xkIiBmaWxsPSIjMDAwIj5GSVRURUQgPC90ZXh0Pjwvc3ZnPg==" alt="FITTED">
                </div>
                
                <nav class="main-nav">
                    <div class="nav-item active" onclick="handleNavigation('Pieces'); return false;">Pieces</div>
                    <div class="nav-item" onclick="handleFits(); return false;">Fits</div>
                    <div class="nav-item" onclick="handleNavigation('Collections'); return false;">Collections</div>
                </nav>

                <nav class="sub-nav">
                    <div class="nav-item active" onclick="handleFilter('All')">All</div>
                    <div class="nav-item" onclick="handleFilter('Favorites')">Favorites</div>
                    <div class="nav-item" onclick="handleFilter('Category')">Category</div>
                    <div class="nav-item" onclick="handleFilter('Type')">Type</div>
                    <div class="nav-item" onclick="handleFilter('Color')">Color</div>
                </nav>
            </header>

            <main>
                <div class="grid-container">
                    <div class="add-piece-card" onclick="showModal(); return false;">
                        <div class="add-icon">+</div>
                        <div class="add-text">Add Piece</div>
                        <div class="piece-count">10/10 Free pieces</div>
                        <button class="upgrade-btn" onclick="event.stopPropagation();">Upgrade ⚡</button>
                    </div>
                    
                    <div class="clothing-grid" id="clothingGrid">
                        <!-- Clothing items will be added here dynamically -->
                    </div>
                </div>

                <!-- Upload Modal -->
                <div class="modal" id="uploadModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Add New Piece</h2>
                            <span class="close">&times;</span>
                        </div>
                        <div class="upload-container">
                            <label for="imageUpload" class="upload-header">
                        <div class="upload-area" id="uploadArea">
                                    <img id="previewImage" src="" alt="Preview">
                                    <div class="upload-placeholder" id="uploadPlaceholder">
                                        <div class="upload-icon">📤</div>
                                        <p class="upload-text">Browse File to upload!</p>
                                    </div>
                                </div>
                            </label>
                            <div class="upload-footer" id="uploadFooter">
                                <p>Not selected file</p>
                        </div>
                            <input type="file" id="imageUpload" accept="image/*" hidden>
                        </div>
                        <div class="preview-actions" id="previewActions">
                            <button class="preview-action-btn" id="autoRemoveBtn">Auto Remove Background</button>
                                <button class="preview-action-btn" id="editImageBtn">✏️</button>
                                <button class="preview-action-btn" id="removeImageBtn">🗑️</button>
                            </div>
                            <div class="form-list">
                                <div class="form-item">
                                    <label for="price">Price</label>
                                    <div class="input-container">
                                        <input type="text" id="price" name="price">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="type">Type</label>
                                    <div class="input-container">
                                        <select id="type" name="type" class="dropdown-select" onchange="checkRequiredFields()">
                                            <option value="">Select type</option>
                                            <option value="accessories">Accessories</option>
                                            <option value="pants">Pants</option>
                                            <option value="shoes">Shoes</option>
                                            <option value="tshirt">T-Shirt</option>
                                            <option value="sweater">Sweater</option>
                                            <option value="jacket">Jacket</option>
                                            <option value="hat">Hat</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="layerType">Layer Type</label>
                                    <div class="input-container">
                                        <input type="text" id="layerType" name="layerType">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="category">Category</label>
                                    <div class="input-container">
                                        <input type="text" id="category" name="category">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="brand">Brand</label>
                                    <div class="input-container">
                                        <input type="text" id="brand" name="brand">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="size">Size</label>
                                    <div class="input-container">
                                        <input type="text" id="size" name="size">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="style">Style</label>
                                    <div class="input-container">
                                        <input type="text" id="style" name="style">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="material">Material</label>
                                    <div class="input-container">
                                        <input type="text" id="material" name="material">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="color">Color</label>
                                    <div class="input-container">
                                        <input type="text" id="color" name="color">
                                        <span class="input-value"></span>
                                    </div>
                                </div>
                                <div class="form-item">
                                    <label for="condition">Condition</label>
                                    <div class="input-container">
                                        <input type="text" id="condition" name="condition">
                                        <span class="input-value"></span>
                                </div>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="upload-action-btn" id="uploadItemBtn" disabled>Add Piece</button>
                        </div>
                    </div>
                </div>

                <!-- Image Editor Modal -->
                <div class="image-editor" id="imageEditor">
                    <div class="editor-content">
                        <div class="editor-canvas-container">
                            <canvas id="editorCanvas" class="editor-canvas"></canvas>
                        </div>
                        <div class="editor-tools">
                            <div class="tool-group">
                                <button class="editor-btn" id="eraserTool">Eraser</button>
                                <input type="range" class="brush-size" id="brushSize" min="1" max="50" value="20">
                            </div>
                            <div class="tool-group">
                                <button class="editor-btn" id="magicWandTool">Magic Wand</button>
                                <button class="editor-btn" id="undoBtn">Undo</button>
                            </div>
                            <div class="tool-group">
                                <button class="editor-btn" id="autoSelect">Auto Remove</button>
                                <button class="editor-btn secondary" id="cancelEdit">Cancel</button>
                                <button class="editor-btn" id="saveEdit">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Create Outfit Button -->
                <button class="create-outfit-btn" id="createOutfitBtn" style="display: none;">
                    Create Outfit
                </button>

                <!-- Add View Details Modal -->
                <div class="details-modal" id="detailsModal">
                    <div class="details-content">
                        <div class="details-image">
                            <img src="" alt="Item">
                            <div class="item-actions">
                                <button class="action-btn edit-details-btn">✏️</button>
                                <button class="action-btn delete-item-btn">🗑️</button>
                            </div>
                        </div>
                        <div class="details-info">
                            <!-- Details will be added dynamically -->
                        </div>
                    </div>
                </div>
            </main>

            <footer>
                <nav class="bottom-nav">
                    <div class="nav-item active" onclick="window.location.reload(); return false;">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNCA3VjE4SDIwVjciIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+" alt="My Closet">
                        <span>My Closet</span>
                    </div>
                    <div class="nav-item" onclick="showProfile(); return false;">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjgiIHI9IjQiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTQgMjBDNCAxNiA3LjU4IDE2IDEyIDE2QzE2LjQyIDE2IDIwIDE2IDIwIDIwIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==" alt="Profile">
                        <span>Profile</span>
                    </div>
                </nav>
            </footer>
        </div>

        <script>
            // Initialize Telegram WebApp
            const tg = window.Telegram.WebApp;
            tg.expand();

            // API configuration
            const API_URL = 'http://localhost:8000';

            // Initialize variables
            let modal = document.getElementById('uploadModal');
            let imageEditor = document.getElementById('imageEditor');
            let editorCanvas = document.getElementById('editorCanvas');
            let uploadArea = document.getElementById('uploadArea');
            let imageUpload = document.getElementById('imageUpload');
            let previewImage = document.getElementById('previewImage');
            let uploadItemBtn = document.getElementById('uploadItemBtn');
            let clothingGrid = document.getElementById('clothingGrid');
            let createOutfitBtn = document.getElementById('createOutfitBtn');
            let addPieceCard = document.querySelector('.add-piece-card');
            let closeBtn = document.querySelector('.close');
            let removeImageBtn = document.getElementById('removeImageBtn');
            let previewActions = document.getElementById('previewActions');
            
            let currentImageData = null;
            let isEditingMode = false;
            const selectedItems = new Set();
            const userId = tg.initDataUnsafe?.user?.id || 'default_user';
            const userProfile = {
                username: tg.initDataUnsafe?.user?.username || 'User',
                firstName: tg.initDataUnsafe?.user?.first_name || '',
                photoUrl: tg.initDataUnsafe?.user?.photo_url || '',
                outfitsCount: 0,
                itemsCount: 0
            };

            // Массив для хранения предметов одежды (будем сохранять в localStorage)
            let userClothingItems = [];
            
            // Загружаем предметы одежды из localStorage
            function loadClothingItemsFromStorage() {
                const storedItems = localStorage.getItem('userClothingItems');
                if (storedItems) {
                    try {
                        userClothingItems = JSON.parse(storedItems);
                        console.log(`Loaded ${userClothingItems.length} items from storage`);
                    } catch (e) {
                        console.error('Failed to parse stored items:', e);
                        userClothingItems = [];
                    }
                }
            }
            
            // Сохраняем предметы одежды в localStorage
            function saveClothingItemsToStorage() {
                localStorage.setItem('userClothingItems', JSON.stringify(userClothingItems));
                console.log(`Saved ${userClothingItems.length} items to storage`);
            }

            // Function to show the modal
            function showModal() {
                console.log('Showing modal');
                modal = document.getElementById('uploadModal');
                if (!modal) {
                    console.error('Modal not found');
                    return;
                }
                
                // Reset form
                resetForm();
                
                // Скрываем теги при открытии модального окна
                const subNav = document.querySelector('.sub-nav');
                if (subNav) {
                    subNav.style.display = 'none';
                }
                
                // Show the modal
                modal.style.display = 'block';
            }

            // Function to close the modal
            function closeModal() {
                console.log('Closing modal');
                modal = document.getElementById('uploadModal');
                if (modal) {
                    modal.style.display = 'none';
                }
                
                // Восстанавливаем видимость тегов при закрытии окна
                const subNav = document.querySelector('.sub-nav');
                if (subNav) {
                    // Только если мы находимся в разделе Pieces
                    const activePieces = document.querySelector('.main-nav .nav-item.active');
                    if (activePieces && activePieces.textContent === 'Pieces') {
                        subNav.style.display = 'flex';
                    }
                }
            }

            // Function to handle loading user items
            function loadUserItems() {
                console.log('Loading user items');
                const clothingGrid = document.getElementById('clothingGrid');
                
                if (!clothingGrid) {
                    console.error('Clothing grid not found');
                    return;
                }
                
                // Clear existing items
                clothingGrid.innerHTML = '';
                
                // Загружаем сохраненные элементы из хранилища
                loadClothingItemsFromStorage();
                
                // Проверяем есть ли элементы
                if (userClothingItems.length === 0) {
                    console.log('No clothing items found');
                    return;
                }
                
                // Отображаем загруженные элементы
                userClothingItems.forEach((item, index) => {
                    const clothingItem = document.createElement('div');
                    clothingItem.className = 'clothing-item';
                    clothingItem.dataset.id = index;
                    
                    let imageHTML = '';
                    if (item.imageUrl) {
                        imageHTML = `<img src="${item.imageUrl}" alt="${item.type || 'Clothing item'}" />`;
                    } else {
                        imageHTML = `<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNmNWY1ZjUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjIwIiBmaWxsPSIjNjY2Ij4ke item.type || 'Item'}</dGV4dD48L3N2Zz4=" alt="${item.type || 'Clothing item'}" />`;
                    }
                    
                    clothingItem.innerHTML = `
                        ${imageHTML}
                        <div class="item-actions">
                            <button class="action-btn edit-item-btn" data-id="${index}">✏️</button>
                            <button class="action-btn delete-item-btn" data-id="${index}">🗑️</button>
                        </div>
                    `;
                    
                    clothingGrid.appendChild(clothingItem);
                });
                
                // Добавляем обработчики событий для кнопок редактирования и удаления
                document.querySelectorAll('.edit-item-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const itemId = this.dataset.id;
                        console.log(`Edit item ${itemId}`);
                        // Здесь можно добавить код для редактирования элемента
                    });
                });
                
                document.querySelectorAll('.delete-item-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const itemId = parseInt(this.dataset.id);
                        console.log(`Delete item ${itemId}`);
                        
                        if (confirm('Вы уверены, что хотите удалить этот предмет?')) {
                            userClothingItems.splice(itemId, 1);
                            saveClothingItemsToStorage();
                            loadUserItems(); // Перезагружаем список
                        }
                    });
                });
                
                // Обновляем счетчик в профиле
                userProfile.itemsCount = userClothingItems.length;
            }

            // Function to handle loading user collections
            function loadUserCollections() {
                console.log('Loading user collections');
                const clothingGrid = document.getElementById('clothingGrid');
                
                if (!clothingGrid) {
                    console.error('Clothing grid not found');
                    return;
                }
                
                // Clear existing items
                clothingGrid.innerHTML = '';
                
                // Тестовые коллекции удалены
                console.log('Ready to display real user collections when available');
            }

            // Navigation handling
            function handleNavigation(section) {
                console.log('Handling navigation to:', section);
                
                // Update active button
                document.querySelectorAll('.main-nav .nav-item').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === section);
                });

                // Get elements
                const subNav = document.querySelector('.sub-nav');
                addPieceCard = document.querySelector('.add-piece-card');
                createOutfitBtn = document.getElementById('createOutfitBtn');
                const gridContainer = document.querySelector('.grid-container');

                isEditingMode = section.toLowerCase() === 'fits';
                
                // Reset selection when switching modes
                selectedItems.clear();
                document.querySelectorAll('.clothing-item').forEach(item => {
                    item.classList.remove('selected');
                });

                console.log('Section:', section.toLowerCase());

                // Handle different sections
                if (section.toLowerCase() === 'fits' || section.toLowerCase() === 'collections') {
                        // Hide sub-navigation and add piece card
                    if (subNav) {
                        console.log('Hiding sub-nav');
                        subNav.style.display = 'none';
                    }
                    if (addPieceCard) {
                        console.log('Hiding add piece card');
                        addPieceCard.style.display = 'none';
                    }
                        
                        // Show create outfit button only for fits
                        if (createOutfitBtn) {
                            createOutfitBtn.style.display = section.toLowerCase() === 'fits' ? 'block' : 'none';
                            if (section.toLowerCase() === 'fits') {
                                createOutfitBtn.style.opacity = '0.5';
                            }
                        }
                        
                        // Enable selection mode for fits only
                        document.querySelectorAll('.clothing-item').forEach(item => {
                            item.classList.toggle('selectable', section.toLowerCase() === 'fits');
                        });

                        // Show grid container
                        if (gridContainer) {
                            gridContainer.style.display = 'grid';
                        }

                        // Load appropriate content
                        section.toLowerCase() === 'fits' ? loadUserItems() : loadUserCollections();
                } 
                else if (section.toLowerCase() === 'pieces') {
                    console.log('Switching to Pieces section');
                    
                    // Recreate main content to ensure proper structure
                    const main = document.querySelector('main');
                    main.innerHTML = `
                        <div class="grid-container">
                            <div class="add-piece-card">
                                <div class="add-icon">+</div>
                                <div class="add-text">Add Piece</div>
                                <div class="piece-count">10/10 Free pieces</div>
                                <button class="upgrade-btn" onclick="event.stopPropagation();">Upgrade ⚡</button>
                            </div>
                            <div class="clothing-grid" id="clothingGrid">
                                <!-- Clothing items will be added here dynamically -->
                            </div>
                        </div>

                        <!-- Upload Modal -->
                        <div class="modal" id="uploadModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>Add New Piece</h2>
                                    <span class="close">&times;</span>
                                </div>
                                <div class="upload-container">
                                    <label for="imageUpload" class="upload-header">
                                        <div class="upload-area" id="uploadArea">
                                            <img id="previewImage" src="" alt="Preview">
                                            <div class="upload-placeholder" id="uploadPlaceholder">
                                                <div class="upload-icon">📤</div>
                                                <p class="upload-text">Browse File to upload!</p>
                                            </div>
                                        </div>
                                    </label>
                                    <div class="upload-footer" id="uploadFooter">
                                        <p>Not selected file</p>
                                    </div>
                                    <input type="file" id="imageUpload" accept="image/*" hidden>
                                </div>
                                <div class="preview-actions" id="previewActions">
                                    <button class="preview-action-btn" id="autoRemoveBtn">Auto Remove Background</button>
                                    <button class="preview-action-btn" id="editImageBtn">✏️</button>
                                    <button class="preview-action-btn" id="removeImageBtn">🗑️</button>
                                </div>
                                <div class="form-list">
                                    <div class="form-item">
                                        <label for="price">Price</label>
                                        <div class="input-container">
                                            <input type="text" id="price" name="price">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="type">Type</label>
                                        <div class="input-container">
                                            <select id="type" name="type" class="dropdown-select" onchange="checkRequiredFields()">
                                                <option value="">Select type</option>
                                                <option value="accessories">Accessories</option>
                                                <option value="pants">Pants</option>
                                                <option value="shoes">Shoes</option>
                                                <option value="tshirt">T-Shirt</option>
                                                <option value="sweater">Sweater</option>
                                                <option value="jacket">Jacket</option>
                                                <option value="hat">Hat</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="layerType">Layer Type</label>
                                        <div class="input-container">
                                            <input type="text" id="layerType" name="layerType">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="category">Category</label>
                                        <div class="input-container">
                                            <input type="text" id="category" name="category">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="brand">Brand</label>
                                        <div class="input-container">
                                            <input type="text" id="brand" name="brand">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="size">Size</label>
                                        <div class="input-container">
                                            <input type="text" id="size" name="size">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="style">Style</label>
                                        <div class="input-container">
                                            <input type="text" id="style" name="style">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="material">Material</label>
                                        <div class="input-container">
                                            <input type="text" id="material" name="material">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                    <div class="form-item">
                                        <label for="color">Color</label>
                                        <div class="input-container">
                                            <input type="text" id="color" name="color">
                                            <span class="input-value"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-actions">
                                    <button class="upload-action-btn" id="uploadItemBtn" disabled>Add Piece</button>
                                </div>
                            </div>
                        </div>

                        <!-- Create Outfit Button -->
                        <button class="create-outfit-btn" id="createOutfitBtn" style="display: none;">
                            Create Outfit
                        </button>
                    `;

                    // Show sub-navigation
                    if (subNav) {
                        subNav.style.display = 'flex';
                    }
                    
                    // Re-define DOM elements after recreation
                    addPieceCard = document.querySelector('.add-piece-card');
                    modal = document.getElementById('uploadModal');
                    uploadArea = document.getElementById('uploadArea');
                    previewImage = document.getElementById('previewImage');
                    imageUpload = document.getElementById('imageUpload');
                    uploadItemBtn = document.getElementById('uploadItemBtn');
                    closeBtn = document.querySelector('.close');
                    removeImageBtn = document.getElementById('removeImageBtn');
                    previewActions = document.getElementById('previewActions');
                    
                    // Initialize event handlers after recreating DOM elements
                    initializeAllHandlers();
                    
                    // Load user items
                    loadUserItems();
                }
            }

            // Function for Fits tab handling
            function handleFits() {
                console.log('Handling Fits tab');
                
                // Update active tab
                document.querySelectorAll('.main-nav .nav-item').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === 'Fits');
                });
                
                // Get elements
                const subNav = document.querySelector('.sub-nav');
                addPieceCard = document.querySelector('.add-piece-card');
                createOutfitBtn = document.getElementById('createOutfitBtn');
                
                // Hide/show elements
                if (subNav) subNav.style.display = 'none';
                if (addPieceCard) addPieceCard.style.display = 'none';
                
                if (createOutfitBtn) {
                    createOutfitBtn.style.display = 'block';
                    createOutfitBtn.style.opacity = '0.5';
                }
                
                // Set editing mode
                isEditingMode = true;
                
                // Reset selection
                selectedItems.clear();
                
                // Enable selection mode for items
                    document.querySelectorAll('.clothing-item').forEach(item => {
                    item.classList.add('selectable');
                        item.classList.remove('selected');
                    });
                
                // Load items
                loadUserItems();
            }

            // Filter handling
            function handleFilter(filter) {
                console.log('Handling filter:', filter);
                
                // Update active button
                document.querySelectorAll('.sub-nav .nav-item').forEach(btn => {
                    btn.classList.toggle('active', btn.textContent === filter);
                });
                
                // Implement filtering logic here
            }

            // Function to show profile
            function showProfile() {
                console.log('Showing profile');
                
                // Update bottom nav active state
                document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                    const navText = item.querySelector('span').textContent;
                    item.classList.toggle('active', navText === 'Profile');
                });
                
                // Replace container content with profile
                const container = document.querySelector('.container');
                container.innerHTML = `
                    <div class="profile">
                        <div class="profile-image" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNjAiIGN5PSI2MCIgcj0iNjAiIGZpbGw9IiNmNWY1ZjUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjQwIiBmaWxsPSIjNjY2Ij5Vc2VyPC90ZXh0Pjwvc3ZnPicp"></div>
                        <div class="profile-info">
                            <h1 class="first-name">${userProfile.firstName || 'User'}</h1>
                            <h1 class="second-name">@${userProfile.username || 'username'}</h1>
                        </div>
                            <div class="profile-stats">
                                <div class="stat-item">
                                <div class="stat-value">${userProfile.itemsCount || 10}</div>
                                    <div class="stat-label">Items</div>
                                </div>
                                <div class="stat-item">
                                <div class="stat-value">${userProfile.outfitsCount || 5}</div>
                                    <div class="stat-label">Outfits</div>
                                </div>
                            <div class="stat-item">
                                <div class="stat-value">0</div>
                                <div class="stat-label">Collections</div>
                            </div>
                        </div>
                    </div>
                    <footer>
                        <nav class="bottom-nav">
                            <div class="nav-item" id="myClosetBtn">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNCA3VjE4SDIwVjciIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+" alt="My Closet">
                                <span>My Closet</span>
                            </div>
                            <div class="nav-item active" id="profileBtn">
                                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjgiIHI9IjQiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIyIi8+PHBhdGggZD0iTTQgMjBDNCAxNiA3LjU4IDE2IDEyIDE2QzE2LjQyIDE2IDIwIDE2IDIwIDIwIiBzdHJva2U9IiMwMDAiIHN0cm9rZS13aWR0aD0iMiIvPjwvc3ZnPg==" alt="Profile">
                                <span>Profile</span>
                            </div>
                        </nav>
                    </footer>
                `;
                
                // Initialize bottom navigation in profile view
                document.getElementById('myClosetBtn').addEventListener('click', function() {
                    window.location.reload();
                });
                
                document.getElementById('profileBtn').addEventListener('click', function() {
                    showProfile();
                });
            }

            // Initialize all handlers
            function initializeAllHandlers() {
                console.log('Initializing all handlers');
                
                // Initialize upload handlers
                initializeUploadHandlers();
                
                // Initialize Add Piece card click
                addPieceCard = document.querySelector('.add-piece-card');
                if (addPieceCard) {
                    addPieceCard.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Add Piece card clicked');
                        showModal();
                    });
                }
                
                // Initialize modal close button
                closeBtn = document.querySelector('.close');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        console.log('Close button clicked');
                        closeModal();
                    });
                }
                
                // Initialize upload button
                uploadItemBtn = document.getElementById('uploadItemBtn');
                if (uploadItemBtn) {
                    uploadItemBtn.addEventListener('click', function() {
                        console.log('Upload button clicked');
                        
                        // Проверяем, есть ли изображение
                        if (!currentImageData) {
                            alert('Please select an image first');
                            return;
                        }
                        
                        // Создаем объект для нового предмета
                        const newItem = {
                            id: Date.now(), // Уникальный ID на основе времени
                            imageUrl: previewImage.src, // URL изображения из превью
                            type: document.getElementById('type')?.value || '',
                            price: document.getElementById('price')?.value || '',
                            layerType: document.getElementById('layerType')?.value || '',
                            category: document.getElementById('category')?.value || '',
                            brand: document.getElementById('brand')?.value || '',
                            size: document.getElementById('size')?.value || '',
                            style: document.getElementById('style')?.value || '',
                            material: document.getElementById('material')?.value || '',
                            color: document.getElementById('color')?.value || '',
                            condition: document.getElementById('condition')?.value || '',
                            dateAdded: new Date().toISOString()
                        };
                        
                        // Добавляем новый предмет в массив
                        userClothingItems.push(newItem);
                        
                        // Сохраняем в localStorage
                        saveClothingItemsToStorage();
                        
                        // Уведомляем пользователя
                        alert('Item added successfully!');
                        
                        // Закрываем модальное окно
                        closeModal();
                        
                        // Перезагружаем список элементов
                        loadUserItems();
                    });
                }
                
                // Initialize navigation items
                const mainNavItems = document.querySelectorAll('.main-nav .nav-item');
                mainNavItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const section = this.textContent;
                        console.log('Main nav clicked:', section);
                        
                        if (section === 'Fits') {
                            handleFits();
                    } else {
                            handleNavigation(section);
                        }
                    });
                });
                
                // Initialize bottom navigation
                const bottomNavItems = document.querySelectorAll('.bottom-nav .nav-item');
                bottomNavItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const navText = this.querySelector('span').textContent;
                        console.log('Bottom nav clicked:', navText);
                        
                        if (navText === 'Profile') {
                            showProfile();
                        } else if (navText === 'My Closet') {
                            window.location.reload();
                        }
                    });
                });
                
                // Initialize sub-navigation
                const subNavItems = document.querySelectorAll('.sub-nav .nav-item');
                subNavItems.forEach(item => {
                    item.addEventListener('click', function() {
                        handleFilter(this.textContent);
                    });
                });
            }

            // Initialize upload handlers
            function initializeUploadHandlers() {
                console.log('Initializing upload handlers');
                
                // Reget DOM elements
                uploadArea = document.getElementById('uploadArea');
                imageUpload = document.getElementById('imageUpload');
                previewImage = document.getElementById('previewImage');
                uploadItemBtn = document.getElementById('uploadItemBtn');
                previewActions = document.getElementById('previewActions');
                removeImageBtn = document.getElementById('removeImageBtn');
                
                if (!uploadArea || !imageUpload) {
                    console.error('Upload elements not found');
                    return;
                    }

                    // Handle click on upload area
                uploadArea.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Upload area clicked');
                        imageUpload.click();
                    });

                    // Handle file selection
                imageUpload.addEventListener('change', function(e) {
                    console.log('Image upload changed');
                        if (e.target.files && e.target.files[0]) {
                            handleImage(e.target.files[0]);
                        }
                    });

                    // Handle drag and drop
                uploadArea.addEventListener('dragover', function(e) {
                        e.preventDefault();
                    this.style.border = '2px dashed #000';
                    this.style.backgroundColor = 'rgba(0, 110, 255, 0.1)';
                    });

                uploadArea.addEventListener('dragleave', function() {
                    this.style.border = '2px dashed #40b6ff';
                    this.style.backgroundColor = 'transparent';
                    });

                uploadArea.addEventListener('drop', function(e) {
                        e.preventDefault();
                    this.style.border = '2px dashed #40b6ff';
                    this.style.backgroundColor = 'transparent';
                        
                        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                            handleImage(e.dataTransfer.files[0]);
                        }
                    });
                
                // Initialize remove image button
                if (removeImageBtn) {
                    removeImageBtn.addEventListener('click', function() {
                        console.log('Remove image clicked');
                        resetForm();
                    });
                }
                
                // Initialize auto remove background button
                const autoRemoveBtn = document.getElementById('autoRemoveBtn');
                if (autoRemoveBtn) {
                    autoRemoveBtn.addEventListener('click', async () => {
                        console.log('Auto Remove Background clicked');
                        
                        if (!currentImageData) {
                            console.error('No image data available');
                            alert('Please upload an image first');
                            return;
                        }
                        
                        try {
                            // Show loading indicator
                            const autoRemoveBtn = document.getElementById('autoRemoveBtn');
                            const originalText = autoRemoveBtn.textContent;
                            autoRemoveBtn.textContent = 'Processing...';
                            autoRemoveBtn.disabled = true;
                            
                            // Create FormData for image upload
                            const formData = new FormData();
                            formData.append('file', currentImageData);
                            
                            // Make the request
                            const response = await fetch('https://45.153.189.61:8000/remove-background', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'Accept': 'image/*'
                                },
                                mode: 'cors'
                            });
                            
                            if (response.ok) {
                                // Get processed image
                                const blob = await response.blob();
                                const objectUrl = URL.createObjectURL(blob);
                                
                                // Update preview and save processed image
                                previewImage.onload = function() {
                                    console.log('Processed image loaded successfully');
                                };
                                previewImage.src = objectUrl;
                                
                                // Replace current image with processed one
                                currentImageData = new File([blob], 'processed_image.png', { type: 'image/png' });
                            } else {
                                console.warn('Server returned error:', await response.text());
                                throw new Error('Server processing failed');
                            }
                            
                            // Restore button state
                            autoRemoveBtn.textContent = originalText;
                            autoRemoveBtn.disabled = false;
                            
                        } catch (error) {
                            console.error('Error in background removal:', error);
                            alert('Failed to remove background. Please try again later.');
                            
                            // Restore button state
                            const autoRemoveBtn = document.getElementById('autoRemoveBtn');
                            autoRemoveBtn.textContent = 'Auto Remove Background';
                            autoRemoveBtn.disabled = false;
                        }
                    });
                }
            }

            // Обработчик для кнопки редактирования изображения
            document.getElementById('editImageBtn').addEventListener('click', function() {
                console.log('Edit Image button clicked');
                
                if (!currentImageData) {
                    console.error('No image data available');
                    alert('Please upload an image first');
                    return;
                }
                
                // Показываем редактор изображений
                const imageEditorElement = document.getElementById('imageEditor');
                if (imageEditorElement) {
                    // Загружаем изображение в редактор
                    const canvasElement = document.getElementById('editorCanvas');
                    if (canvasElement) {
                        const ctx = canvasElement.getContext('2d');
                        const img = new Image();
                        img.onload = function() {
                            // Настраиваем размер канваса
                            canvasElement.width = img.width;
                            canvasElement.height = img.height;
                            
                            // Отрисовываем изображение
                            ctx.drawImage(img, 0, 0);
                            
                            // Показываем редактор
                            imageEditorElement.style.display = 'block';
                        };
                        img.src = URL.createObjectURL(currentImageData);
                    }
                } else {
                    alert('Image editor is not available');
                }
            });

            // Инициализация редактора изображений
            const setupImageEditor = function() {
                // Получаем элементы редактора
                const editorEl = document.getElementById('imageEditor');
                const canvasEl = document.getElementById('editorCanvas');
                const eraserToolEl = document.getElementById('eraserTool');
                const magicWandToolEl = document.getElementById('magicWandTool');
                const undoBtnEl = document.getElementById('undoBtn');
                const saveEditBtnEl = document.getElementById('saveEdit');
                const cancelEditBtnEl = document.getElementById('cancelEdit');
                const brushSizeEl = document.getElementById('brushSize');
                
                if (!canvasEl || !eraserToolEl) {
                    console.warn('Image editor elements not found');
                    return;
                }

                // Переменные для рисования
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;
                let eraserActive = false;
                let currentBrushSize = 20;
                let canvasHistory = [];
                
                // Контекст канваса
                const ctx = canvasEl.getContext('2d');
                
                // Сохраняем историю для отмены
                function saveState() {
                    canvasHistory.push(canvasEl.toDataURL());
                    if (canvasHistory.length > 10) { // Ограничиваем историю
                        canvasHistory.shift();
                    }
                }
                
                // Отмена последнего действия
                undoBtnEl.addEventListener('click', function() {
                    if (canvasHistory.length > 0) {
                        const img = new Image();
                        img.onload = function() {
                            ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
                            ctx.drawImage(img, 0, 0);
                        };
                        img.src = canvasHistory.pop();
                    }
                });
                
                // Включаем инструмент ластика
                eraserToolEl.addEventListener('click', function() {
                    eraserActive = true;
                    eraserToolEl.classList.add('active');
                    magicWandToolEl.classList.remove('active');
                });
                
                // Включаем инструмент волшебной палочки
                magicWandToolEl.addEventListener('click', function() {
                    eraserActive = false;
                    magicWandToolEl.classList.add('active');
                    eraserToolEl.classList.remove('active');
                    alert('Magic Wand tool: Click on the area you want to remove');
                });
                
                // Размер кисти
                brushSizeEl.addEventListener('input', function() {
                    currentBrushSize = this.value;
                });
                
                // Функции рисования ластиком
                canvasEl.addEventListener('mousedown', function(e) {
                    isDrawing = true;
                    saveState(); // Сохраняем состояние перед рисованием
                    
                    const rect = canvasEl.getBoundingClientRect();
                    lastX = e.clientX - rect.left;
                    lastY = e.clientY - rect.top;
                });
                
                canvasEl.addEventListener('mousemove', function(e) {
                    if (!isDrawing) return;
                    
                    const rect = canvasEl.getBoundingClientRect();
                    const currentX = e.clientX - rect.left;
                    const currentY = e.clientY - rect.top;
                    
                    if (eraserActive) {
                        // Рисуем ластиком (прозрачные круги)
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.beginPath();
                        ctx.arc(currentX, currentY, currentBrushSize/2, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    lastX = currentX;
                    lastY = currentY;
                });
                
                canvasEl.addEventListener('mouseup', function() {
                    isDrawing = false;
                });
                
                canvasEl.addEventListener('mouseout', function() {
                    isDrawing = false;
                });
                
                // Магическая палочка (упрощенная версия)
                canvasEl.addEventListener('click', function(e) {
                    if (eraserActive) return; // Только для режима волшебной палочки
                    
                    const rect = canvasEl.getBoundingClientRect();
                    const x = Math.floor(e.clientX - rect.left);
                    const y = Math.floor(e.clientY - rect.top);
                    
                    // Здесь должна быть реализация алгоритма Magic Wand
                    // В простом варианте просто удаляем большую область
                    saveState();
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.beginPath();
                    ctx.arc(x, y, 50, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.globalCompositeOperation = 'source-over';
                });
                
                // Кнопка "Сохранить"
                saveEditBtnEl.addEventListener('click', function() {
                    // Преобразуем canvas в изображение
                    canvasEl.toBlob(function(blob) {
                        // Обновляем превью
                        const previewImage = document.getElementById('previewImage');
                        previewImage.src = URL.createObjectURL(blob);
                        
                        // Обновляем текущее изображение
                        currentImageData = new File([blob], 'edited_image.png', { type: 'image/png' });
                        
                        // Обновляем текст футера
                        const uploadFooter = document.getElementById('uploadFooter');
                        if (uploadFooter) {
                            uploadFooter.innerHTML = '<p>edited_image.png</p>';
                        }
                        
                        // Закрываем редактор
                        editorEl.style.display = 'none';
                    });
                });
                
                // Кнопка "Отмена"
                cancelEditBtnEl.addEventListener('click', function() {
                    editorEl.style.display = 'none';
                });
                
                console.log('Image editor initialized');
            };
            
            // Инициализируем редактор при загрузке страницы
            document.addEventListener('DOMContentLoaded', function() {
                setupImageEditor();
            });

            // Handle image preview
            function handleImage(file) {
                console.log('Handling image:', file?.name);
                
                if (!file || !file.type.startsWith('image/')) {
                    console.error('Invalid file type');
                    alert('Please upload an image file');
                    return;
                }
                
                // Reget DOM elements for safety
                previewImage = document.getElementById('previewImage');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                const uploadFooter = document.getElementById('uploadFooter');
                uploadItemBtn = document.getElementById('uploadItemBtn');
                previewActions = document.getElementById('previewActions');
                
                if (!previewImage || !uploadPlaceholder) {
                    console.error('Preview elements not found');
                    return;
                }
                
                try {
                    // Create object URL and set up image
                    const objectUrl = URL.createObjectURL(file);
                    
                    // Setup onload handler first
                    previewImage.onload = function() {
                        console.log('Preview image loaded');
                                
                                // Enable upload button
                                if (uploadItemBtn) {
                                    uploadItemBtn.disabled = false;
                                }
                                
                        // Show preview actions
                        if (previewActions) {
                            previewActions.style.display = 'flex';
                        }
                    };
                    
                    // Set source to trigger onload
                    previewImage.src = objectUrl;
                    
                    // Show preview and hide placeholder
                    previewImage.style.display = 'block';
                    uploadPlaceholder.style.display = 'none';
                    
                    // Update footer
                    if (uploadFooter) {
                        uploadFooter.innerHTML = `<p>${file.name}</p>`;
                    }
                    
                    // Store file for upload
                    currentImageData = file;
                    
                    console.log('Image preview set up successfully');
                } catch (error) {
                    console.error('Error handling image:', error);
                    alert('Failed to display image. Please try again.');
                }
            }

            // Reset form function
            function resetForm() {
                console.log('Resetting form');
                
                // Reget DOM elements for safety
                previewImage = document.getElementById('previewImage');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                const uploadFooter = document.getElementById('uploadFooter');
                uploadArea = document.getElementById('uploadArea');
                uploadItemBtn = document.getElementById('uploadItemBtn');
                previewActions = document.getElementById('previewActions');
                
                // Reset image preview
                if (previewImage) {
                    previewImage.src = '';
                    previewImage.style.display = 'none';
                }
                
                // Show placeholder
                if (uploadPlaceholder) {
                    uploadPlaceholder.style.display = 'flex';
                }
                
                // Reset upload area
                if (uploadArea) {
                    uploadArea.style.border = '2px dashed #40b6ff';
                    uploadArea.style.backgroundColor = 'transparent';
                }
                
                // Reset footer
                if (uploadFooter) {
                    uploadFooter.innerHTML = '<p>Not selected file</p>';
                }
                
                // Disable upload button
                if (uploadItemBtn) {
                    uploadItemBtn.disabled = true;
                }
                
                // Clear current image data
                currentImageData = null;
            }

            // Initialize everything on page load
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM content loaded');
                
                // Загружаем предметы из localStorage
                loadClothingItemsFromStorage();
                
                // Initialize all handlers
                initializeAllHandlers();
                
                // Load user items
                loadUserItems();
                
                // Обновляем счетчик доступных слотов
                updatePieceCounter();
            });
            
            // Функция для обновления счетчика предметов
            function updatePieceCounter() {
            const pieceCountElement = document.querySelector('.piece-count');
            if (pieceCountElement) {
                    const usedSlots = userClothingItems.length;
                    const totalSlots = 10; // Бесплатное ограничение
                    pieceCountElement.textContent = `${usedSlots}/${totalSlots} Free pieces`;
                    
                    // Визуально подсвечиваем, если пользователь близок к лимиту
                    if (usedSlots >= totalSlots) {
                        pieceCountElement.style.color = '#ff4d4d';
                    } else if (usedSlots >= totalSlots * 0.8) {
                        pieceCountElement.style.color = '#ffa64d';
                    } else {
                        pieceCountElement.style.color = '#666';
                    }
                }
            }
        </script>

        <!-- Import Ionicons -->
        <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    </body>
    </html> 
